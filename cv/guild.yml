- config: detection-lib-support
  resources:
    detection-lib:
      description: Object detection Python libraries
      private: yes
      sources:
        - url: https://github.com/tensorflow/models/archive/887bbcb9ddc046eff66ce10c681edbc2ae8bac6a.zip
          sha256: fede456a860a44afcc42e9b3eda7453f50c7d18005e8ceb577a19fa7d32d35bb
          select:
            - models-887bbcb9ddc046eff66ce10c681edbc2ae8bac6a/research/object_detection
            - models-887bbcb9ddc046eff66ce10c681edbc2ae8bac6a/research/slim/deployment
            - models-887bbcb9ddc046eff66ce10c681edbc2ae8bac6a/research/slim/nets
          post-process: >
            cd models-887bbcb9ddc046eff66ce10c681edbc2ae8bac6a
            && patch -p1 < $(resource-src patches/object_detection.patch)
            && cd research
            && protoc object_detection/protos/*.proto --python_out .

- config: detection-model
  extends: detection-lib-support
  params:
    images-dir: images
    annotations-dir: annotations
    labels: labels.pbtxt
    object-class-method: object
    dataset-name: data
  operations:
    prepare-data:
      description: Prepare {{dataset-name}} for training and evaluation
      main:
        pascal_voc
          --images-dir {{images-dir}}
          --annotations-dir {{annotations-dir}}
          --labels {{labels}}
          --object-class-method {{object-class-method}}
      requires:
        - detection-lib
        - labeled-data
    finetune:
      description: Finetune {{model-name}}
      main: train --model-dir model {{pipeline-config}}
      requires:
        - detection-lib
        - pipeline-config
        - pretrained-model
        - prepared-data
  resources:
    pipeline-config:
      description: Config for detection pipeline
      sources:
        - '{{pipeline-config}}'
    pretrained-model:
      description: Pretrained model used for finetuning
      path: checkpoint
      sources:
        # TODO: move somewhere else (e.g. defined by model)
        - url: http://download.tensorflow.org/models/object_detection/ssd_mobilenet_v2_coco_2018_03_29.tar.gz
          sha256: b9380178b2e35333f1a735e39745928488bdabeb9ed20bc6fa07af8172cb5adc
          select: ssd_mobilenet_v2_coco_2018_03_29/.*
    prepared-data:
      description: Data prepared for training
      path: data
      sources:
        - operation: prepare-data
          select: .+\.record

- model: ssd-mobilenet-v1
  extends: detection-model
  params:
    model-name: MobileNet v1
  description: MobileNet v1
