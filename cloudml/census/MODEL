- name: census-dnn
  description: Wide and deep classifier for census income data using TensorFlow estimators
  operations:
    train:
      description: Train the classifier locally
      cmd: >
        trainer/task
          --train-files census-data/adult.data.csv
          --eval-files census-data/adult.test.csv
          --job-dir .
      flags:
        epochs:
          description: >
            Number of training data epochs

            If both train-steps and epochs are specified, the training
            job will run for train-steps or epochs, whichever occurs
            first. If unspecified will run for train-steps.
          arg-name: num-epochs
        train-batch-size:
          description: Batch size for training steps
          default: 40
        eval-batch-size:
          description: Batch size for evaluation steps
          default: 40
        embedding-size:
          description: Number of embedding dimensions for categorical columns
          default: 8
        first-layer-size:
          description: Number of nodes in the first layer of the DNN
          default: 100
        layers:
          description: Number of layers in the DNN
          default: 4
          arg-name: num-layers
        scale-factor:
          description: How quickly the size of the layers in the DNN decay
          default: 0.7
        verbosity:
          description: >
            Log level (use DEBUG for more information)

            Values may be DEBUG, INFO, WARN, ERROR, or FATAL.
          default: INFO
        train-steps:
          description: Steps to run the training job for
          default: 1000
        eval-steps:
          description: Number of steps to run evalution for at each checkpoint
          default: 100
        export-format:
          description: >
            The input format of the exported SavedModel binary

            Values may be JSON, CSV, or EXAMPLE.
          default: JSON
      requires:
        - trainer
        - cloudml.datasets/census
    cloudml-train:
      description: Train the classifier in Cloud ML
      plugin-op: cloudml-train
    cloudml-hptune:
      description: Tune model hyperparameters in Cloud ML
      plugin-op: cloudml-hptune
      flags:
        config:
          description: Hyperparameter tuning configuration
          default: hptuning_config.yaml
      requires:
        - hptuning-config
    cloudml-deploy:
      description: Deploy a trained classifier in Cloud ML
      plugin-op: cloudml-deploy
    cloudml-predict:
      description: Perform an online prediction using a model deployed in Cloud ML
      plugin-op: cloudml-predict
      flags:
        instances:
          default: sample-instances.json
      requires:
        - sample-instances
    cloudml-batch-predict:
      description: Submit a prediction job using a model deployed in Cloud ML
      plugin-op: cloudml-batch-predict
      flags:
        instances:
          default: sample-instances.json
      requires:
        - sample-instances
  resources:
    trainer:
      description: Census trainer
      private: yes
      sources:
        - url: https://github.com/GoogleCloudPlatform/cloudml-samples/archive/c272e9f3bf670404fb1570698d8808ab62f0fc9a.zip
          sha256: 25b18e94e2ecbf6e74360f032267cbc733831823c6aa84f97d29258f73a72842
          select: cloudml-samples-c272e9f3bf670404fb1570698d8808ab62f0fc9a/census/estimator/trainer
    hptuning-config:
      description: Default hyperparameter tuning configuration
      private: yes
      sources:
        - hptuning_config.yaml
    sample-instances:
      description: Sample instances for prediction
      private: yes
      sources:
        - sample-instances.json
  extra:
    scalar_map:
      eval_census-eval/accuracy: val_acc
      eval_census-eval/loss: loss
    compare:
      flags:
        - train-steps
        - layers
        - first-layer-size
        - scale-factor
