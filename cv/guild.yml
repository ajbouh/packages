- config: detection-lib-support
  resources:
    detection-lib:
      description: Object detection Python libraries
      private: yes
      sources:
        - url: https://github.com/tensorflow/models/archive/4285be595492351aff42b31d7aadf842eb34d7f3.zip
          sha256: 0d86f9fa7afd6ea1e217e06a326c46d6f638434eeeeea3252e4af4b45054f3fc
          select:
            - models-4285be595492351aff42b31d7aadf842eb34d7f3/research/object_detection
            - models-4285be595492351aff42b31d7aadf842eb34d7f3/research/slim/deployment
            - models-4285be595492351aff42b31d7aadf842eb34d7f3/research/slim/nets
          post-process: >
            cd models-4285be595492351aff42b31d7aadf842eb34d7f3/research &&
            protoc object_detection/protos/*.proto --python_out .

- config: detection-model
  extends: detection-lib-support
  operations:
    prepare-data:
      description: Prepare data for training and evaluation
      main: prepare_data
    finetune:
      description: Finetune {{model-name}}
      main: train
      requires:
        - detection-lib
        - pipeline-config
        - pretrained-model
        - prepared-data
  resources:
    pipeline-config:
      description: Config for detection pipeline
      sources:
        # TODO: move somewhere else (either generated by train.py or
        # defined by model)
        - pet-detector.config
    pretrained-model:
      description: Pretrained model used for finetuning
      path: checkpoint
      sources:
        # TODO: move somewhere else (e.g. defined by model)
        - url: http://download.tensorflow.org/models/object_detection/ssd_mobilenet_v2_coco_2018_03_29.tar.gz
          sha256: b9380178b2e35333f1a735e39745928488bdabeb9ed20bc6fa07af8172cb5adc
          select: ssd_mobilenet_v2_coco_2018_03_29/.*

    prepared-data:
      description: Data prepared for training
      path: data
      sources:
        - operation: prepare-data
          select: .+\.record-.+

- model: ssd-mobilenet-v2
  extends: detection-model
  params:
    model-name: MobileNet v2
  description: SSD MobileNet v2

- config: pet-dataset-support
  description: Support for training with the Oxford-IIIT pet dataset
  extends: detection-lib-support
  operations:
    prepare-data:
      description: Prepare Oxford-IIIT pet dataset for training
      main: >
        object_detection/dataset_tools/create_pet_tf_record
          --label_map_path object_detection/data/pet_label_map.pbtxt
          --nofaces_only
          --data_dir .
          --output_dir .
      requires:
        - detection-lib
        - pet-images
  resources:
    pet-images:
      description: Oxford-IIIT pet images with annotations
      sources:
        - url: https://s3.amazonaws.com/guild-pub/oxford-pets/images.tar.gz
          sha256: 67195c5e1c01f1ab5f9b6a5d22b8c27a580d896ece458917e61d459337fa318d
        - url: https://s3.amazonaws.com/guild-pub/oxford-pets/annotations.tar.gz
          sha256: 52425fb6de5c424942b7626b428656fcbd798db970a937df61750c0f1d358e91

- model: pet-detector
  description: Pet detector using MobileNet v2
  extends:
    - pet-dataset-support
    - ssd-mobilenet-v2
  params:
    model-name: pet detector
