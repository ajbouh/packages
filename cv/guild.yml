- config: detection-lib-support
  description:
    Defines 'detection-lib' resource - the Python library supporting
    the object_detection framework
  resources:
    detection-lib:
      description: Object detection Python libraries
      private: yes
      sources:
        - url: https://github.com/tensorflow/models/archive/887bbcb9ddc046eff66ce10c681edbc2ae8bac6a.zip
          sha256: fede456a860a44afcc42e9b3eda7453f50c7d18005e8ceb577a19fa7d32d35bb
          select:
            - models-887bbcb9ddc046eff66ce10c681edbc2ae8bac6a/research/object_detection
            - models-887bbcb9ddc046eff66ce10c681edbc2ae8bac6a/research/slim/deployment
            - models-887bbcb9ddc046eff66ce10c681edbc2ae8bac6a/research/slim/nets
          post-process: >
            cd models-887bbcb9ddc046eff66ce10c681edbc2ae8bac6a
            && patch -p1 < $(project-src patches/object_detection.patch)
            && cd research
            && protoc object_detection/protos/*.proto --python_out .

- config: detection-model
  description: Base config for detection models
  extends: detection-lib-support
  params:
    pipeline-config: ''
    dataset-config: ''
    model-config: ''
    train-config: ''
    eval-config: ''
  operations:
    finetune:
      description: Finetune {{model-name}}
      main:
        train
          --pipeline-config '{{pipeline-config}}'
          --dataset-config '{{dataset-config}}'
          --model-config '{{model-config}}'
          --train-config '{{train-config}}'
          --eval-config '{{eval-config}}'
      env:
        PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION: python
      flags:
        config:
          description:
            Additional YAML formatted config to apply to operation
          arg-name: extra-config
        train-steps:
          description:
            Number of training steps (default trains indefinitely)
      stoppable: yes
      requires:
        - detection-lib
        - prepared-data
        - finetune-checkpoint
    evaluate:
      description: Evaluate trained {{model-name}}
      main:
        eval
          --checkpoint-dir checkpoint
          --pipeline-config '{{pipeline-config}}'
          --dataset-config '{{dataset-config}}'
          --model-config '{{model-config}}'
          --train-config '{{train-config}}'
          --eval-config '{{eval-config}}'
      env:
        PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION: python
      flags:
        eval-examples:
          description:
            Number of examples to evaluate (default is model specific)
      requires:
        - detection-lib
        - prepared-data
        - eval-checkpoint
  resources:
    prepared-data:
      description: Data prepared for training
      path: data
      sources:
        - operation: prepare-data
          select: .+\.record.*
    eval-checkpoint:
      description: Checkpoint generated by finetune operation
      path: checkpoint
      sources:
        - operation: finetune
          select:
            - model/model\.ckpt-.+
            - model/checkpoint

- config: pascal-voc-dataset-support
  params:
    images-dir: images
    annotations-dir: annotations
    labels: labels.pbtxt
    object-class-method: object
  operations:
    prepare-data:
      description: Prepare dataset for training and evaluation
      main:
        pascal_voc
          --images-dir {{images-dir}}
          --annotations-dir {{annotations-dir}}
          --labels {{labels}}
          --object-class-method {{object-class-method}}
      requires:
        - detection-lib
        - labeled-data

- config: pet-dataset-support
  description:
    Defines 'prepare-dataset' operation for Oxford-IIIT pet dataset
  params:
    dataset-config: config/datasets/pet.yml
  operations:
    prepare-data:
      description: Prepare Oxford-IIIT pet dataset for training and evaluation
      main:
        object_detection.dataset_tools.create_pet_tf_record
          --label_map_path=object_detection/data/pet_label_map.pbtxt
          --data_dir=data
          --output_dir=.
      requires:
        - detection-lib
        - pet-dataset
  resources:
    pet-dataset:
      path: data
      sources:
        - url: http://www.robots.ox.ac.uk/~vgg/data/pets/data/images.tar.gz
          sha256: 67195c5e1c01f1ab5f9b6a5d22b8c27a580d896ece458917e61d459337fa318d
        - url: http://www.robots.ox.ac.uk/~vgg/data/pets/data/annotations.tar.gz
          sha256: 52425fb6de5c424942b7626b428656fcbd798db970a937df61750c0f1d358e91

- config: faster-rcnn-resnet-101-coco-checkpoint-support
  description:
    Defines 'finetune-checkpoint' resource for Faster RCNN ResNet 101
    trained on MS-COCO
  resources:
    finetune-checkpoint:
      description: Faster RCNN ResNet 101 model pretrained on MS-COCO
      path: checkpoint
      sources:
        - url: http://storage.googleapis.com/download.tensorflow.org/models/object_detection/faster_rcnn_resnet101_coco_11_06_2017.tar.gz
          sha256: f08a8475b1abae663bef51234545baa8c44972a8c16cfcaea0a41330426fed02
          select: faster_rcnn_resnet101_coco_11_06_2017/.*

- config: ssd-mobilenet-v2-coco-support
  description:
    Defines 'finetune-checkpoint' resource for SDD MobileNet v2 trained
    on MS-COCO
  resources:
    finetune-checkpoint:
      description: SSD MobileNet v2 model pretrained on MS-COCO
      path: checkpoint
      sources:
        - url: http://download.tensorflow.org/models/object_detection/ssd_mobilenet_v2_coco_2018_03_29.tar.gz
          sha256: b9380178b2e35333f1a735e39745928488bdabeb9ed20bc6fa07af8172cb5adc
          select: ssd_mobilenet_v2_coco_2018_03_29/.*

- model: faster-rcnn-resnet-101
  description: Faster RCCN ResNet 101
  extends: detection-model
  params:
    model-name: Faster RCNN ResNet 101
    model-config: config/models/faster-rcnn-resnet-101.yml
    train-config: config/train/momentum-default.yml

- model: ssd-mobilenet-v1
  description: MobileNet v1
  extends: detection-model
  params:
    model-name: MobileNet v1
