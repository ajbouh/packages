# Copyright 2018 TensorHub, Inc. and contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# ===================================================================
# Package def
# ===================================================================

- package: gpkg.slim.models
  version: 0.5.0.dev1
  description: TF-Slim models
  url: https://github.com/guildai/packages/tree/master/slim/models
  author: Guild AI
  author-email: packages@guild.ai
  license: Apache 2.0
  tags: [slim]
  requires:
    - Pillow

# ===================================================================
# Generic images support
# ===================================================================

- model: images
  description: Generic images dataset
  extends:
    - gpkg.slim/directory-images

# ===================================================================
# Image classifiers
# ===================================================================

- model: inception-v1
  description: TF-Slim Inception v1 classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/inception-v1

- model: inception-v2
  description: TF-Slim Inception v2 classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/inception-v2

- model: inception-v3
  description: TF-Slim Inception v3 classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/inception-v3

- model: inception-v4
  description: TF-Slim Inception v4 classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/inception-v4

- model: inception-resnet-v2
  description: TF-Slim Inception ResNet v2 classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/inception-resnet-v2

- model: resnet-v1-50
  description: TF-Slim ResNet v1 50 layer classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/resnet-v1-50

- model: resnet-v1-101
  description: TF-Slim ResNet v1 101 layer classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/resnet-v1-101

- model: resnet-v1-152
  description: TF-Slim ResNet v1 152 layer classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/resnet-v1-152

- model: resnet-v2-50
  description: TF-Slim ResNet v2 50 layer classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/resnet-v2-50

- model: resnet-v2-101
  description: TF-Slim ResNet v2 101 layer classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/resnet-v2-101

- model: resnet-v2-152
  description: TF-Slim ResNet v2 152 layer classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/resnet-v2-152

- model: vgg-16
  description: TF-Slim VGG 16 classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/vgg-16

- model: vgg-19
  description: TF-Slim VGG 19 classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/vgg-19

- model: mobilenet-v1
  description: TF-Slim Mobilenet v1 classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/mobilenet-v1

- model: mobilenet-v2-1.4
  description: TF-Slim Mobilenet v2 classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/mobilenet-v2-1.4

- model: nasnet-mobile
  description: TF-Slim NASNet mobile classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/nasnet-mobile

- model: nasnet-large
  description: TF-Slim NASNet large classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/nasnet-large

- model: pnasnet-mobile
  description: TF-Slim PNASNet mobile classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/pnasnet-mobile

- model: pnasnet-large
  description: TF-Slim PNASNet classifier
  extends:
    - gpkg.slim/directory-images-resources
    - gpkg.slim/pnasnet-large

# ===================================================================
# Tests
# ===================================================================

- test: all
  env-dir: test/env
  models:
    - inception-v1
    - inception-v2
    - inception-v3
    - inception-v4
    - inception-resnet-v2
    - resnet-v1-50
    - resnet-v1-101
    - resnet-v1-152
    - resnet-v2-50
    - resnet-v2-101
    - resnet-v2-152
    - mobilenet-v1
    - mobilenet-v2-1.4
    - nasnet-large
    - nasnet-mobile
    - pnasnet-large
    - pnasnet-mobile
    - vgg-16
    - vgg-19
  tests:
    - help:
        compare-to: test/help
    - op: images:prepare
      flags:
        images: test/sample-images
        random-seed: 801
      expected:
        - file: data/train-weights.txt
          compare-to: test/train-weights.txt
    - model-op: transfer-learn
      flags:
        auto-scale: no
        clone_on_cpu: 'True'
        train-steps: 1
      expected:
        - file: train/checkpoint
        - file: train/graph.pbtxt
    - model-op: evaluate
      flags:
        max-batches: 1
        batch-size: 5
      expected:
        - output: eval/Accuracy\[.+\]eval/Recall_5[1]
    - model-op: export-and-freeze
      expected:
        - file: graph.pb
        - file: frozen_graph.pb
